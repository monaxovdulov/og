# MVP Backlog: Telegram Quiz Bot

Этот документ фиксирует задачи MVP-квиза, сформированные на основе `ARCHITECTURE.md` и `ux_flow.md`. Приоритеты: P0 — критично для запуска; P1 — важно для UX; P2 — дополнительные улучшения. Оценка усилий: S/M/L.

## Список задач

### MVP-001 — P0 — Загрузчик банка и валидации (M)
- **Описание:** реализовать полную загрузку `topics.json` и `questions.json` при старте бота с индексацией и проверками (уникальность `question.id`, валидность `topic_ids`, соответствие форматов).
- **Где менять:** `app/repo.py` (`__init__`, `_load_topics`, `_load_questions`).
- **Зависимости:** нет.
- **DoD:**
  1. При запуске строятся индексы `q_by_id`, `q_by_topic`, `q_by_topic_diff`.
  2. Некорректные данные вызывают осознанные исключения с логированием.
  3. Успешная загрузка логируется единоразово.
- **Риски/заметки:** большой JSON → использовать потоковое чтение нет необходимости, но следить за атомарной заменой.

### MVP-002 — P0 — Ленивое создание пользователя (S)
- **Описание:** обеспечить `repo.ensure_user` создание профиля с дефолтными `prefs`, пустой `session`, метаданными при `/start`.
- **Где менять:** `app/repo.py` (`ensure_user`), `app/commands.py` (`handle_start`).
- **Зависимости:** MVP-001.
- **DoD:**
  1. Новый пользователь появляется в `users.json` после `/start`.
  2. Повторный `/start` не дублирует запись.
  3. Логируется событие создания профиля.

### MVP-003 — P0 — Главное меню и клавиатуры (S)
- **Описание:** сверить и привести главное меню к UX-гайдам: кнопки «Играть», «Рейтинг» (заглушка), «Настройки», «Темы», «Помощь».
- **Где менять:** `app/commands.py`, `app/keyboards.py`, `app/handlers.py` (роуты).
- **Зависимости:** MVP-002.
- **DoD:**
  1. `/start` отображает меню с нужными кнопками и текстами.
  2. Повторные нажатия устойчивы за счёт CallbackShield.
  3. Локализация строк вынесена в константы.

### MVP-004 — P0 — Экран «Темы» и пагинация (M)
- **Описание:** отрендерить сетку тем 2×N из данных репозитория с пагинацией и действиями `p:topic:<id>`.
- **Где менять:** `app/handlers.py` (обработчик списка тем), `app/keyboards.py` (генератор пагинации), `app/repo.py` (методы выдачи тем).
- **Зависимости:** MVP-001, MVP-003.
- **DoD:**
  1. Темы выводятся из `topics.json` без хардкода.
  2. Пагинация корректно переключает страницы и не выходит за пределы.
  3. Пустой список тем обрабатывается уведомлением.

### MVP-005 — P0 — Старт серии по теме (M)
- **Описание:** реализовать `repo.start_session` с учётом `prefs` (`qcount`, `diff`), формировать случайную выборку вопросов и обрабатывать дефицит банка.
- **Где менять:** `app/repo.py`, `app/handlers.py` (точка вызова), `app/callbacks.py` (роут `p:topic`).
- **Зависимости:** MVP-001, MVP-004.
- **DoD:**
  1. При успешном старте создаётся `session` с заполненными полями.
  2. Если вопросов мало — возвращается сигнал для UX-алерта без изменения `session`.
  3. Сессия записывается в `users.json` атомарно.

### MVP-006 — P0 — Рендер вопроса и общие кнопки (M)
- **Описание:** построить шаблон сообщения для вопроса (заголовок, statement, question, панель «Решение», «Дальше», «Меню») с учётом текущего индекса и режима решений.
- **Где менять:** `app/handlers.py` (рендер и отправка), `app/keyboards.py` (инлайн-кнопки).
- **Зависимости:** MVP-005.
- **DoD:**
  1. Сообщение содержит корректный заголовок «Тема · i/N · сложность».
  2. Кнопка «Дальше →» неактивна до принятого ответа.
  3. Перерисовка происходит через `edit_message_text`, если возможно.

### MVP-007 — P0 — Ответ `single_choice` (S)
- **Описание:** обработать клик по варианту: зафиксировать ответ, сверить с `correct_answer`, показать фидбек, активировать «Дальше →`.
- **Где менять:** `app/handlers.py`, `app/callbacks.py`, `app/repo.py` (`record_answer`).
- **Зависимости:** MVP-006.
- **DoD:**
  1. Коллбек `q:opt:<qid>:<index>` фиксирует ответ и обновляет `session.answers`.
  2. Фидбек отражает корректность и не дублируется при повторном тапе.
  3. `users.json` обновляется после ответа.

### MVP-008 — P0 — Ответ `multi_choice` (M)
- **Описание:** реализовать выбор и фиксацию нескольких вариантов: локальные отметки, обработка «Принять выбор», сравнение множеств.
- **Где менять:** `app/handlers.py`, `app/keyboards.py`, `app/callbacks.py`, `app/repo.py`.
- **Зависимости:** MVP-006.
- **DoD:**
  1. Пользователь может отмечать/снимать варианты без записи в сессию до коммита.
  2. Коммит обновляет `answers` и даёт фидбек.
  3. Состояние не ломается при повторных коммитах.

### MVP-009 — P0 — Ответ `numeric` (M)
- **Описание:** поддержать «Ввести ответ» → ожидание текстового сообщения, нормализацию числа и фиксацию результата.
- **Где менять:** `app/handlers.py`, `app/callbacks.py`, `app/repo.py` (флаги `await_input`), `app/core.py` (регистрация message handler).
- **Зависимости:** MVP-006.
- **DoD:**
  1. Включается режим ожидания и сохраняется в `session.await_input`.
  2. Сообщение пользователя нормализуется (пробелы, запятая → точка) и валидируется.
  3. Невалидный ввод оставляет режим ожидания и отправляет подсказку.

### MVP-010 — P0 — Ответ `text` (M)
- **Описание:** аналогично numeric, но с текстовой нормализацией (`lower`, trim, схлопывание пробелов) и строгим сравнением.
- **Где менять:** `app/handlers.py`, `app/callbacks.py`, `app/repo.py`.
- **Зависимости:** MVP-009.
- **DoD:**
  1. Текст нормализуется и сравнивается строго.
  2. Поддерживается кнопка «Отмена ввода» с возвратом к состоянию `asking`.
  3. Повторное сообщение после фиксации игнорируется корректно.

### MVP-011 — P0 — Кнопка «Дальше →» и навигация (S)
- **Описание:** обеспечить переход к следующему вопросу/итогам: `repo.advance`, перерисовка сообщения или показ нового.
- **Где менять:** `app/handlers.py`, `app/callbacks.py`, `app/repo.py` (`advance`, `get_current_question`).
- **Зависимости:** MVP-007–MVP-010.
- **DoD:**
  1. После правильной работы кнопки индекс увеличивается и показывается следующий вопрос.
  2. На последнем вопросе кнопка заменяется на «Завершить серию».
  3. Нельзя перейти дальше без ответа.

### MVP-012 — P0 — Экран итогов и решения (M)
- **Описание:** сформировать итоговое сообщение с результатами и, при `sol=end`, блок решений по вопросам.
- **Где менять:** `app/handlers.py`, `app/repo.py` (`finish`, сбор решений), `app/keyboards.py` (кнопки итогов).
- **Зависимости:** MVP-011.
- **DoD:**
  1. Итоги содержат счёт `correct/total`, тему и CTA-кнопки.
  2. `session` сбрасывается, `stats` обновляются.
  3. Решения отображаются согласно режиму prefs.

### MVP-013 — P1 — Настройки пользователя (S)
- **Описание:** реализовать экран настроек с выбором `qcount`, `diff`, `sol`, мгновенное сохранение в профиле.
- **Где менять:** `app/handlers.py`, `app/keyboards.py`, `app/repo.py` (`update_prefs`).
- **Зависимости:** MVP-002.
- **DoD:**
  1. Каждая настройка меняется одним тапом и подсвечивается.
  2. Изменения пишутся в `users.json` и применяются к новым сериям.
  3. Возврат в меню работает одной кнопкой.

### MVP-014 — P1 — Продолжение незавершённой сессии (M)
- **Описание:** при наличии активной `session` после рестарта показывать «⏸ Продолжить» в «Играть» и восстанавливать текущий вопрос.
- **Где менять:** `app/handlers.py`, `app/commands.py`, `app/repo.py` (`get_session_state`).
- **Зависимости:** MVP-005, MVP-011.
- **DoD:**
  1. При рестарте бота пользователь возвращается в ту же точку.
  2. Отсутствие сессии скрывает кнопку «Продолжить».
  3. Повторный выбор «Продолжить» не создаёт дубликатов.

### MVP-015 — P1 — Логи и аналитика событий (S)
- **Описание:** добавить структурированные логи для ключевых событий: старт серии, принятие ответа, завершение серии, ошибки ввода.
- **Где менять:** `app/handlers.py`, `app/repo.py`, `app/core.py` (конфиг логгера).
- **Зависимости:** MVP-005–MVP-012.
- **DoD:**
  1. Логгер настраивается уровнем из окружения.
  2. Каждое событие фиксируется с user_id и `question_id`.
  3. Ошибки записи/валидации выводятся с уровнем ERROR.

### MVP-016 — P2 — Экран помощи и заглушки (S)
- **Описание:** вывести статический текст помощи и заглушку для «Рейтинг» до появления функционала.
- **Где менять:** `app/handlers.py`, `app/keyboards.py`.
- **Зависимости:** MVP-003.
- **DoD:**
  1. Кнопка «Помощь» показывает текстовый справочник.
  2. Кнопка «Рейтинг» отвечает заглушкой без ошибок.
  3. Возврат в меню работает из обоих экранов.

## Примечания
- Все изменения должны учитывать ограничения Telegram: 64 байта `callback_data`, 4096 символов сообщения.
- Для каждого обработчика требуется оборачивать длительные операции в CallbackShield (уже реализован, важно не блокировать его работу).
- Проверки данных (`VALIDATION_RULES.md`) расширять по мере необходимости, но MVP покрыт задачами выше.
